---
import BaseLayout from '../../layouts/BaseLayout.astro';
import RSVPForm from '../../components/RSVPForm.astro';

// Configuración de API
const apiUrl = import.meta.env.API_URL || 'http://localhost:3001';

// Verificar autenticación del lado del servidor
let user = null;
let error = null;

try {
  // En un entorno real, necesitarías pasar las cookies de sesión
  // Por ahora, manejamos la autenticación del lado del cliente
  
} catch (e) {
  console.error('Error checking auth:', e);
}
---

<BaseLayout title="Confirmar Asistencia - Sheila & Habib">
  <main class="min-h-screen bg-warm-beige py-12">
    <div class="container mx-auto px-4 max-w-3xl">
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
        <!-- Header -->
        <div class="bg-gold text-white p-8 text-center">
          <h1 class="font-serif text-4xl mb-4">Sheila & Habib</h1>
          <div class="w-16 h-0.5 bg-white mx-auto mb-4"></div>
          <p class="text-xl mb-2">4 de Julio, 2026</p>
          <p class="text-gold-100">
            ¡Cuéntanos si vienes a la fiesta!
          </p>
        </div>

        <!-- Formulario -->
        <div class="p-8">
          <RSVPForm />
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="mt-8 text-center space-y-4">
        <button
          id="download-summary"
          class="bg-gray-800 text-white px-8 py-3 rounded-lg font-medium hover:bg-gray-700 transition-colors shadow-sm"
        >
          Descargar Resumen del Evento
        </button>
        
        <div>
          <a
            href="/"
            class="inline-block bg-warm-beige text-gray-800 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition-colors border border-gray-300"
          >
            Volver a la Página Principal
          </a>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ apiUrl }}>
  // Verificar autenticación al cargar la página
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch(`${apiUrl}/auth/me`, {
        credentials: 'include'
      });
      
      if (!response.ok) {
        // No autenticado, redirigir al login
        window.location.href = '/rsvp/login';
        return;
      }
      
      const data = await response.json();
      if (!data.success) {
        window.location.href = '/rsvp/login';
      }
    } catch (error) {
      console.error('Error checking auth:', error);
      window.location.href = '/rsvp/login';
    }
  });

  // Manejar descarga de resumen
  document.getElementById('download-summary')?.addEventListener('click', () => {
    const link = document.createElement('a');
    link.href = '/images/summary/resumenBodaSheilaYHabib.png';
    link.download = 'resumenBodaSheilaYHabib.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
</script>