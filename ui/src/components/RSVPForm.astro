---
// Componente del formulario RSVP
const apiUrl = import.meta.env.API_URL || 'http://localhost:3001';
---

<div id="rsvp-form-container">
  <!-- Loading state -->
  <div id="loading-state" class="text-center py-8">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
    <p class="text-text-muted">Cargando tu información...</p>
  </div>

  <!-- Formulario principal -->
  <form id="rsvp-form" class="hidden space-y-8">
    <!-- Información personal -->
    <div class="bg-surface-1 rounded-lg p-6">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">Tu Información</h3>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label for="name" class="block text-sm font-medium text-text-secondary mb-2">
            Nombre completo (como quieres que aparezca en la boda)
          </label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
            placeholder="Tu nombre completo"
          />
          <p class="text-xs text-text-muted mt-1">Puedes editarlo si es diferente al de tu cuenta de Google</p>
        </div>
        
        <div>
          <label for="email" class="block text-sm font-medium text-text-secondary mb-2">
            Email
          </label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            readonly
            class="w-full px-4 py-3 border border-border-strong rounded-lg bg-surface-2 text-text-muted"
          />
        </div>
        
        <div>
          <label for="phone" class="block text-sm font-medium text-text-secondary mb-2">
            Teléfono (opcional)
          </label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
            placeholder="+34 600 000 000"
          />
        </div>

        <div>
          <label for="gender" class="block text-sm font-medium text-text-secondary mb-2">
            Sexo
          </label>
          <select 
            id="gender" 
            name="gender" 
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
          >
            <option value="">Seleccionar</option>
            <option value="masculino">Masculino</option>
            <option value="femenino">Femenino</option>
            <option value="otro">Otro</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Confirmación de asistencia -->
    <div class="bg-bg-panel border border-border-strong/60 rounded-lg p-6">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">¿Vienes a la fiesta?</h3>
      </div>
      
      <div class="space-y-4">
        <label class="flex items-center space-x-4 cursor-pointer p-4 border border-border-strong/60 rounded-lg hover:bg-status-success/10 transition-colors">
          <input 
            type="radio" 
            name="attending" 
            value="true" 
            class="w-5 h-5 text-accent focus:ring-accent"
          />
          <span class="text-lg font-medium text-text-secondary">Sí, estaré presente</span>
        </label>
        
        <label class="flex items-center space-x-4 cursor-pointer p-4 border border-border-strong/60 rounded-lg hover:bg-status-danger/10 transition-colors">
          <input 
            type="radio" 
            name="attending" 
            value="false" 
            class="w-5 h-5 text-accent focus:ring-accent"
          />
          <span class="text-lg font-medium text-text-secondary">No podré asistir</span>
        </label>
      </div>
    </div>

    <!-- Preferencias alimentarias -->
    <div id="dietary-section" class="bg-bg-panel border border-border-strong/60 rounded-lg p-6 hidden">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">Preferencias Alimentarias</h3>
      </div>
      
      <div class="space-y-8">
        <!-- Menú del invitado principal -->
        <div class="border-l-4 border-accent pl-4">
          <h4 class="font-medium text-text-secondary mb-4">Tu menú</h4>
          <div class="space-y-4">
            <div>
              <label for="menu_choice" class="block text-sm font-medium text-text-secondary mb-2">
                Menú preferido
              </label>
              <select 
                id="menu_choice" 
                name="menu_choice" 
                class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
              >
                <option value="">Selecciona una opción</option>
                <option value="carne">Menú con carne</option>
                <option value="pescado">Menú con pescado</option>
                <option value="vegetariano">Menú vegetariano</option>
                <option value="vegano">Menú vegano</option>
              </select>
            </div>
            
            <div>
              <label for="dietary_restrictions" class="block text-sm font-medium text-text-secondary mb-2">
                Restricciones alimentarias
              </label>
              <textarea 
                id="dietary_restrictions" 
                name="dietary_restrictions" 
                rows="2" 
                class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
                placeholder="Ej: Sin gluten, sin lactosa, alergia a frutos secos..."
              ></textarea>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Acompañantes y Niños -->
    <div id="plus-one-section" class="bg-bg-panel border border-border-strong/60 rounded-lg p-6 hidden">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">Acompañantes</h3>
      </div>
      
      <div class="space-y-6">
        <!-- Acompañantes adultos -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <span class="font-medium text-text-secondary">Acompañantes adultos</span>
            <button type="button" id="add-companion-btn"
              class="flex items-center space-x-2 text-sm text-accent hover:text-accent-hover font-medium disabled:opacity-40 disabled:cursor-not-allowed">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              <span>Añadir acompañante</span>
            </button>
          </div>
          <div id="companions-list" class="space-y-4"></div>
          <p id="companions-empty-hint" class="text-sm text-text-muted mt-2">
            Pulsa "Añadir acompañante" para incluir a alguien en tu grupo.
          </p>
        </div>

        <!-- Niños -->
        <div>
          <label class="flex items-center space-x-4 cursor-pointer p-4 border border-border-strong/60 rounded-lg hover:bg-surface-1 transition-colors">
            <input 
              type="checkbox" 
              id="children" 
              name="children" 
              class="w-5 h-5 text-accent focus:ring-accent rounded"
            />
            <span class="font-medium text-text-secondary">Vendré con niños</span>
          </label>
          
          <div id="children-details" class="hidden mt-4 space-y-4">
            <div>
              <label for="children_count" class="block text-sm font-medium text-text-secondary mb-2">
                Número de niños
              </label>
              <select 
                id="children_count" 
                name="children_count" 
                class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
              >
                <option value="">Seleccionar</option>
                <option value="1">1 niño</option>
                <option value="2">2 niños</option>
                <option value="3">3 niños</option>
                <option value="4">4 o más niños</option>
              </select>
            </div>
            
            <div>
              <label for="children_names" class="block text-sm font-medium text-text-secondary mb-2">
                Nombres de los niños
              </label>
              <textarea 
                id="children_names" 
                name="children_names" 
                rows="3" 
                class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
                placeholder="Nombres y edades de los niños (ej: Ana 5 años, Carlos 8 años)"
              ></textarea>
            </div>

            <div>
              <label for="children_dietary_restrictions" class="block text-sm font-medium text-text-secondary mb-2">
                Alergias o intolerancias de los niños
              </label>
              <textarea
                id="children_dietary_restrictions"
                name="children_dietary_restrictions"
                rows="2"
                class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
                placeholder="Ej: alergia a frutos secos, intolerancia a la lactosa..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bus Lanzadera -->
    <div id="transport-section" class="bg-bg-panel border border-border-strong/60 rounded-lg p-6 hidden">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3z"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">Transporte</h3>
      </div>
      
      <div class="space-y-4">
        <label class="flex items-center space-x-4 cursor-pointer p-4 border border-border-strong/60 rounded-lg hover:bg-surface-1 transition-colors">
          <input 
            type="checkbox" 
            id="shuttle_bus" 
            name="shuttle_bus" 
            class="w-5 h-5 text-accent focus:ring-accent rounded"
          />
          <div>
            <span class="font-medium text-text-secondary block">Necesito bus lanzadera</span>
            <span class="text-sm text-text-muted">Servicio de transporte al evento (más detalles próximamente)</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Comentarios adicionales -->
    <div id="notes-section" class="bg-bg-panel border border-border-strong/60 rounded-lg p-6 hidden">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center mr-4">
          <svg class="w-5 h-5 text-accent-contrast" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h3 class="font-serif text-xl text-text-secondary">Comentarios</h3>
      </div>
      
      <div>
        <label for="notes" class="block text-sm font-medium text-text-secondary mb-2">
          ¿Algo más que quieras contarnos?
        </label>
        <textarea 
          id="notes" 
          name="notes" 
          rows="4" 
          class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
          placeholder="¡Cuéntanos lo que quieras! Felicitaciones, sugerencias, necesidades especiales..."
        ></textarea>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
      <button 
        type="submit" 
        id="submit-btn"
        class="flex-1 bg-accent text-accent-contrast py-4 px-8 rounded-lg font-medium hover:bg-accent-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Confirmar Asistencia
      </button>
      
      <button 
        type="button" 
        id="logout-btn"
        class="bg-text-primary text-text-inverse py-4 px-8 rounded-lg font-medium hover:bg-text-secondary transition-colors"
      >
        Cerrar Sesión
      </button>
    </div>
  </form>

  <!-- Mensaje de éxito -->
  <div id="success-message" class="hidden text-center py-12">
    <div class="w-16 h-16 bg-status-success/15 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-8 h-8 text-status-success" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
    </div>
    <h3 class="font-serif text-2xl text-text-secondary mb-4">¡Genial, ya lo tenemos!</h3>
    <p class="text-text-muted mb-6 max-w-md mx-auto">Gracias por confirmar tu asistencia.</p>

    <div id="success-details" class="bg-bg-panel border border-border-strong/60 rounded-lg p-5 mb-8 text-left max-w-lg mx-auto space-y-3 text-sm">
      <!-- populated by JS -->
    </div>

    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <button 
        id="edit-rsvp-btn"
        class="bg-accent text-accent-contrast px-8 py-3 rounded-lg font-medium hover:bg-accent-hover transition-colors"
      >
        Editar mi Confirmación
      </button>
      
      <a
        href="/guest-dashboard"
        class="bg-text-primary text-text-inverse px-8 py-3 rounded-lg font-medium hover:bg-text-secondary transition-colors text-center"
      >
        Ver mi Confirmación
      </a>
    </div>
  </div>
</div>

<script define:vars={{ apiUrl }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const loadingState = document.getElementById('loading-state');
    const rsvpForm = document.getElementById('rsvp-form');
    const successMessage = document.getElementById('success-message');
    
    try {
      // Verificar autenticación y cargar datos
      const authResponse = await fetch(`${apiUrl}/auth/me`, {
        credentials: 'include'
      });
      
      if (!authResponse.ok) {
        window.location.href = '/rsvp/login';
        return;
      }
      
      const authData = await authResponse.json();
      if (!authData.success) {
        window.location.href = '/rsvp/login';
        return;
      }
      
      // Cargar datos del RSVP
      const rsvpResponse = await fetch(`${apiUrl}/api/rsvp/form`, {
        credentials: 'include'
      });
      
      if (rsvpResponse.ok) {
        const rsvpData = await rsvpResponse.json();
        console.log('RSVP Data received:', rsvpData);
        if (rsvpData.success) {
          console.log('Populating form with data:', rsvpData.form);
          populateForm(rsvpData.form);
          loadingState?.classList.add('hidden');
          rsvpForm?.classList.remove('hidden');
        } else {
          loadingState?.classList.add('hidden');
          rsvpForm?.classList.remove('hidden');
        }
      } else {
        console.error('Failed to load RSVP data:', rsvpResponse.status);
        loadingState?.classList.add('hidden');
        rsvpForm?.classList.remove('hidden');
      }
      
    } catch (error) {
      console.error('Error loading RSVP data:', error);
      window.location.href = '/rsvp/login';
    }
  });

  function populateSuccessDetails(data) {
    const el = document.getElementById('success-details');
    if (!el) return;

    const attending = data.attending === 1 || data.attending === true;
    const menuLabels = { carne: 'Menú con carne', pescado: 'Menú con pescado', vegetariano: 'Menú vegetariano', vegano: 'Menú vegano' };
    const genderLabels = { masculino: 'Masculino', femenino: 'Femenino', otro: 'Otro' };

    function row(label, value) {
      return `<div class="flex justify-between gap-4"><span class="text-text-muted shrink-0">${label}:</span><span class="font-medium text-right">${value}</span></div>`;
    }

    const rows = [];

    rows.push(`<div class="flex justify-between"><span class="text-text-muted">Asistencia:</span><span class="font-medium ${attending ? 'text-status-success' : 'text-status-danger'}">${attending ? 'Confirmada ✓' : 'No asiste'}</span></div>`);

    if (data.phone) rows.push(row('Teléfono', data.phone));
    if (data.gender) rows.push(row('Género', genderLabels[data.gender] || data.gender));
    if (attending && data.menu_choice) rows.push(row('Tu menú', menuLabels[data.menu_choice] || data.menu_choice));
    if (attending && data.dietary_restrictions) rows.push(row('Restricciones', data.dietary_restrictions));

    if (attending && (data.companions || []).length > 0) {
      const list = data.companions.map(c => `${c.name}${c.menu_choice ? ` — ${menuLabels[c.menu_choice] || c.menu_choice}` : ''}`).join('<br>');
      rows.push(`<div><span class="text-text-muted block mb-1">Acompañantes (${data.companions.length}):</span><span class="font-medium">${list}</span></div>`);
    }

    if (attending && data.children) {
      rows.push(row('Niños', `${data.children_count}${data.children_names ? ` (${data.children_names})` : ''}`));
      if (data.children_dietary_restrictions) rows.push(row('Alergias/intolerancias niños', data.children_dietary_restrictions));
    }

    if (attending && data.needs_transport) rows.push(row('Transporte', 'Bus lanzadera solicitado'));
    if (data.notes) rows.push(row('Notas', data.notes));

    el.innerHTML = rows.join('<hr class="border-border-strong/30">') || '<p class="text-text-muted">Sin detalles adicionales.</p>';
  }

  function populateForm(data) {
    console.log('=== POPULATE FORM DEBUG ===');
    console.log('Data received:', data);
    
    // Llenar campos básicos
    document.getElementById('name').value = data.name || '';
    document.getElementById('email').value = data.email || '';
    document.getElementById('phone').value = data.phone || '';
    
    console.log('Basic fields populated');
    
    // Información personal
    if (data.gender) {
      console.log('Setting gender:', data.gender);
      document.getElementById('gender').value = data.gender;
    }
    
    // Asistencia
    if (data.attending !== null) {
      console.log('Setting attending:', data.attending);
      // Convertir número a string boolean
      const attendingValue = data.attending === 1 || data.attending === true ? "true" : "false";
      const attendingRadio = document.querySelector(`input[name="attending"][value="${attendingValue}"]`);
      if (attendingRadio) {
        attendingRadio.checked = true;
        toggleSections(attendingValue === "true");
        console.log('Attending radio set and sections toggled');
      }
    }
    
    // Acompañantes
    companionCount = 0;
    document.getElementById('companions-list').innerHTML = '';
    for (const companion of (data.companions || [])) {
      addCompanion(companion);
    }
    updateCompanionUI();
    
    // Niños
    if (data.children) {
      console.log('Setting children data:', data.children_count, data.children_names);
      document.getElementById('children').checked = true;
      if (data.children_count) {
        document.getElementById('children_count').value = data.children_count;
      }
      document.getElementById('children_names').value = data.children_names || '';
      document.getElementById('children_dietary_restrictions').value = data.children_dietary_restrictions || '';
      
      // Mostrar secciones de niños
      document.getElementById('children-details')?.classList.remove('hidden');
    }
    
    // Menú y restricciones dietéticas del invitado principal
    console.log('Menu choice:', data.menu_choice);
    if (data.menu_choice) {
      document.getElementById('menu_choice').value = data.menu_choice;
    }
    console.log('Dietary restrictions:', data.dietary_restrictions);
    document.getElementById('dietary_restrictions').value = data.dietary_restrictions || '';
    
    // Transporte
    console.log('Transport data:', data.needs_transport);
    if (data.needs_transport === "on" || data.needs_transport === true || data.needs_transport === 1) {
      console.log('Setting shuttle_bus checked');
      document.getElementById('shuttle_bus').checked = true;
    }
    
    // Notas adicionales
    document.getElementById('notes').value = data.notes || '';
    
    // Actualizar visibilidad de todas las secciones después de cargar los datos
    updateFormVisibility();
    
    console.log('=== POPULATE FORM COMPLETE ===');
  }

  // Función para actualizar la visibilidad de todas las secciones del formulario
  function updateFormVisibility() {
    // Verificar estado de asistencia
    const attendingRadio = document.querySelector('input[name="attending"]:checked');
    if (attendingRadio) {
      toggleSections(attendingRadio.value === 'true');
    }
  }

  function toggleSections(attending) {
    const sections = ['plus-one-section', 'dietary-section', 'transport-section', 'notes-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (attending) {
        section?.classList.remove('hidden');
      } else {
        section?.classList.add('hidden');
      }
    });
  }

  // Companion management
  const MAX_COMPANIONS = 5;
  let companionCount = 0;

  function renderCompanionCard(index, data = {}) {
    return `
      <div data-companion-index="${index}" class="relative bg-surface-1 border border-border-strong/60 rounded-lg p-4">
        <button type="button" class="remove-companion-btn absolute top-3 right-3 text-text-muted hover:text-status-danger transition-colors" aria-label="Eliminar acompañante">✕</button>
        <p class="text-sm font-medium text-text-secondary mb-3">Acompañante ${index + 1}</p>
        <div class="grid md:grid-cols-2 gap-4">
          <input
            type="text"
            name="companions[${index}][name]"
            value="${data.name || ''}"
            placeholder="Nombre completo"
            required
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
          />
          <select
            name="companions[${index}][menu_choice]"
            required
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
          >
            <option value="">Selecciona una opción</option>
            <option value="carne" ${data.menu_choice === 'carne' ? 'selected' : ''}>Menú con carne</option>
            <option value="pescado" ${data.menu_choice === 'pescado' ? 'selected' : ''}>Menú con pescado</option>
            <option value="vegetariano" ${data.menu_choice === 'vegetariano' ? 'selected' : ''}>Menú vegetariano</option>
            <option value="vegano" ${data.menu_choice === 'vegano' ? 'selected' : ''}>Menú vegano</option>
          </select>
        </div>
        <div class="mt-3">
          <select
            name="companions[${index}][gender]"
            required
            class="w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
          >
            <option value="">Selecciona sexo</option>
            <option value="masculino" ${data.gender === 'masculino' ? 'selected' : ''}>Masculino</option>
            <option value="femenino" ${data.gender === 'femenino' ? 'selected' : ''}>Femenino</option>
            <option value="otro" ${data.gender === 'otro' ? 'selected' : ''}>Otro</option>
          </select>
        </div>
        <input
          type="text"
          name="companions[${index}][dietary_restrictions]"
          value="${data.dietary_restrictions || ''}"
          placeholder="Restricciones alimentarias (opcional)"
          class="mt-3 w-full px-4 py-3 border border-border-strong rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
        />
      </div>
    `;
  }

  function reindexCompanions() {
    const cards = document.querySelectorAll('#companions-list [data-companion-index]');
    cards.forEach((card, i) => {
      card.setAttribute('data-companion-index', i);
      card.querySelector('p').textContent = `Acompañante ${i + 1}`;
      card.querySelectorAll('input, select').forEach(el => {
        el.name = el.name.replace(/companions\[\d+\]/, `companions[${i}]`);
      });
    });
    companionCount = cards.length;
  }

  function updateCompanionUI() {
    const addBtn = document.getElementById('add-companion-btn');
    const hint = document.getElementById('companions-empty-hint');
    if (addBtn) addBtn.disabled = companionCount >= MAX_COMPANIONS;
    if (hint) hint.classList.toggle('hidden', companionCount > 0);
  }

  function addCompanion(data = {}) {
    const list = document.getElementById('companions-list');
    if (!list || companionCount >= MAX_COMPANIONS) return;
    const div = document.createElement('div');
    div.innerHTML = renderCompanionCard(companionCount, data);
    const card = div.firstElementChild;
    card.querySelector('.remove-companion-btn').addEventListener('click', () => {
      card.remove();
      reindexCompanions();
      updateCompanionUI();
    });
    list.appendChild(card);
    companionCount++;
    updateCompanionUI();
  }

  document.getElementById('add-companion-btn')?.addEventListener('click', () => addCompanion());

  // Event listeners
  document.addEventListener('change', (e) => {
    const target = e.target;

    if (target.name === 'attending') {
      toggleSections(target.value === 'true');
    }

    if (target.id === 'children') {
      const childrenDetails = document.getElementById('children-details');
      if (target.checked) {
        childrenDetails?.classList.remove('hidden');
      } else {
        childrenDetails?.classList.add('hidden');
        document.getElementById('children_count').value = '';
        document.getElementById('children_names').value = '';
        document.getElementById('children_dietary_restrictions').value = '';
      }
    }
  });

  // Submit form
  document.getElementById('rsvp-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';
    
    try {
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      // Serializar acompañantes desde los campos dinámicos
      const companionsList = [];
      let ci = 0;
      while (document.querySelector(`[name="companions[${ci}][name]"]`)) {
        companionsList.push({
          name: (document.querySelector(`[name="companions[${ci}][name]"]`).value || '').trim(),
          menu_choice: document.querySelector(`[name="companions[${ci}][menu_choice]"]`).value || null,
          dietary_restrictions: (document.querySelector(`[name="companions[${ci}][dietary_restrictions]"]`).value || '').trim() || null,
          gender: document.querySelector(`[name="companions[${ci}][gender]"]`)?.value || null
        });
        ci++;
      }
      data.companions = companionsList;

      // Convertir valores
      data.attending = data.attending === 'true';

      // Validaciones de negocio
      const validationErrors = [];

      if (data.attending) {
        data.companions.forEach((companion, index) => {
          const companionLabel = `Acompañante ${index + 1}`;
          if (!companion.name) {
            validationErrors.push(`${companionLabel}: el nombre es obligatorio.`);
          }
          if (!companion.menu_choice) {
            validationErrors.push(`${companionLabel}: debes seleccionar un tipo de menú.`);
          }
          if (!companion.gender) {
            validationErrors.push(`${companionLabel}: debes seleccionar el sexo.`);
          }
        });

        if (data.children === 'on') {
          const childrenCount = parseInt(data.children_count, 10) || 0;
          const childrenNames = (data.children_names || '').trim();

          if (childrenCount <= 0) {
            validationErrors.push('Si vienes con niños, debes indicar cuántos niños vienen.');
          }
          if (!childrenNames) {
            validationErrors.push('Si vienes con niños, debes rellenar los nombres de los niños.');
          }
        }
      }

      if (validationErrors.length > 0) {
        throw new Error(validationErrors.join('\n'));
      }

      // Eliminar campos legacy que puedan venir del FormData
      delete data.plus_one; delete data.plus_one_name; delete data.plus_one_gender;
      
      const response = await fetch(`${apiUrl}/api/rsvp/form`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        const responseData = await response.json();
        populateSuccessDetails(responseData.form);
        document.getElementById('rsvp-form')?.classList.add('hidden');
        document.getElementById('success-message')?.classList.remove('hidden');
      } else {
        throw new Error('Error saving RSVP');
      }
      
    } catch (error) {
      console.error('Error submitting RSVP:', error);
      alert(error?.message || 'Error al guardar. Por favor, inténtalo de nuevo.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Confirmar Asistencia';
    }
  });

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
      await fetch(`${apiUrl}/auth/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      window.location.href = '/';
    } catch (error) {
      console.error('Error logging out:', error);
    }
  });

  // Edit RSVP
  document.getElementById('edit-rsvp-btn')?.addEventListener('click', () => {
    document.getElementById('success-message')?.classList.add('hidden');
    document.getElementById('rsvp-form')?.classList.remove('hidden');
    // Actualizar visibilidad del formulario al editarlo
    updateFormVisibility();
  });
</script>
