---
import BaseLayout from "../../layouts/BaseLayout.astro";

const apiUrl = import.meta.env.API_URL || 'http://localhost:3001';
---

<BaseLayout title="Dashboard Admin - Sheila & Habib">
  <main class="min-h-screen bg-surface-1">
    <!-- Header -->
    <header class="bg-bg-panel shadow-sm border-b border-border-strong/60">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-4 py-5 sm:flex-row sm:justify-between sm:items-center">
          <div>
            <h1 class="font-serif text-2xl text-text-secondary">Panel de Administraci√≥n</h1>
            <p class="text-sm text-text-muted">Boda Sheila & Habib - 4 de Julio, 2026</p>
          </div>
          <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center sm:gap-4">
            <span id="admin-name" class="text-sm text-text-secondary"></span>
            <button id="logout-btn" class="w-full sm:w-auto bg-text-primary text-text-inverse px-4 py-2 rounded-lg text-sm font-medium hover:bg-text-secondary transition-colors">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
        <p class="text-text-muted">Cargando datos...</p>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard-content" class="hidden">
        <!-- Navigation Tabs -->
        <div class="mb-8 border-b border-border-strong/60 pb-3">
          <nav class="tabs-scroll flex gap-2 overflow-x-auto px-0.5 pb-1" aria-label="Tabs">
            <button id="tab-overview" class="tab-button active snap-start shrink-0 whitespace-nowrap py-2.5 px-3 border text-sm rounded-md">
              üìä Resumen General
            </button>
            <button id="tab-analytics" class="tab-button snap-start shrink-0 whitespace-nowrap py-2.5 px-3 border text-sm rounded-md">
              üìà Estad√≠sticas Avanzadas
            </button>
            <button id="tab-invitations" class="tab-button snap-start shrink-0 whitespace-nowrap py-2.5 px-3 border text-sm rounded-md">
              üìß Invitaciones Enviadas
            </button>
            <button id="tab-guests" class="tab-button snap-start shrink-0 whitespace-nowrap py-2.5 px-3 border text-sm rounded-md">
              üë• Lista de Invitados
            </button>
          </nav>
        </div>

        <!-- Tab Content: Overview -->
        <div id="content-overview" class="tab-content">
          <!-- Statistics Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-status-success/15 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-status-success" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-text-muted">Confirmados</p>
                  <p id="confirmed-count" class="text-2xl font-bold text-text-primary">-</p>
                </div>
              </div>
            </div>

            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-status-danger/15 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-status-danger" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-text-muted">No Asisten</p>
                  <p id="declined-count" class="text-2xl font-bold text-text-primary">-</p>
                </div>
              </div>
            </div>

            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-status-warning/15 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-status-warning" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-text-muted">Pendientes</p>
                  <p id="pending-count" class="text-2xl font-bold text-text-primary">-</p>
                </div>
              </div>
            </div>

            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-status-info/15 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-status-info" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 18v-4h3v4h2v-7.5c0-.83.67-1.5 1.5-1.5S12 9.67 12 10.5V11h2.5c.83 0 1.5.67 1.5 1.5V18h2v4H4v-4z"/>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-text-muted">Total Personas</p>
                  <p id="total-people-overview" class="text-2xl font-bold text-text-primary">-</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-4 mb-8">
            <button id="create-invitation-btn" class="bg-accent text-accent-contrast px-6 py-3 rounded-lg font-medium hover:bg-accent-hover transition-colors">
              Crear Invitaci√≥n
            </button>
            <button id="export-json-btn" class="bg-text-primary text-text-inverse px-6 py-3 rounded-lg font-medium hover:bg-text-secondary transition-colors">
              Exportar JSON
            </button>
            <button id="export-csv-btn" class="bg-text-secondary text-text-inverse px-6 py-3 rounded-lg font-medium hover:bg-text-muted transition-colors">
              Exportar CSV
            </button>
            <button id="refresh-btn" class="bg-status-info text-text-inverse px-6 py-3 rounded-lg font-medium hover:bg-status-info/80 transition-colors">
              Actualizar Datos
            </button>
          </div>

          <!-- Recent Responses Table -->
          <div class="bg-bg-panel rounded-lg shadow-sm border border-border-soft/60 overflow-hidden">
            <div class="px-6 py-4 border-b border-border-strong/60">
              <h3 class="font-serif text-lg text-text-secondary">Respuestas Recientes</h3>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-border-strong/60">
                <thead class="bg-surface-2">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Nombre</th>
                    <th class="hidden lg:table-cell px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Estado</th>
                    <th class="hidden md:table-cell px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Acompa√±ante</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Fecha</th>
                  </tr>
                </thead>
                <tbody id="guests-table-body" class="bg-bg-panel divide-y divide-border-strong/60">
                  <!-- Contenido din√°mico -->
                </tbody>
              </table>
            </div>
          </div>
        </div>      
  <!-- Tab Content: Advanced Analytics -->
        <div id="content-analytics" class="tab-content hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Demographics -->
            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <h3 class="font-serif text-lg text-text-secondary mb-4">üë• Demograf√≠a</h3>
              <div class="space-y-4">
                <div>
                  <h4 class="font-medium text-text-secondary mb-2">Por G√©nero</h4>
                  <div id="gender-stats" class="space-y-2"></div>
                </div>
                <div class="flex justify-between items-center mt-4">
                  <span class="text-text-secondary">Total Ni√±os:</span>
                  <span id="demographics-children" class="font-bold text-text-secondary">-</span>
                </div>
              </div>
            </div>

            <!-- Catering -->
            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <h3 class="font-serif text-lg text-text-secondary mb-4">üçΩÔ∏è Catering</h3>
              <div class="space-y-4">
                <div>
                  <h4 class="font-medium text-text-secondary mb-2">Opciones de Men√∫</h4>
                  <div id="menu-stats" class="space-y-2"></div>
                </div>
                <div>
                  <h4 class="font-medium text-text-secondary mb-2">Restricciones Diet√©ticas</h4>
                  <div id="dietary-stats" class="space-y-2"></div>
                </div>
              </div>
            </div>

            <!-- Logistics -->
            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <h3 class="font-serif text-lg text-text-secondary mb-4">üöå Log√≠stica</h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Necesitan Transporte:</span>
                  <span id="transport-needed" class="font-bold text-status-info">-</span>
                </div>
                <div>
                  <h4 class="font-medium text-text-secondary mb-2">Personas con transporte</h4>
                  <div id="transport-people-list" class="space-y-2">
                    <p class="text-text-muted text-sm">Sin datos disponibles</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- People Count -->
            <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
              <h3 class="font-serif text-lg text-text-secondary mb-4">üìä Conteo Total</h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Total Personas:</span>
                  <span id="total-people" class="font-bold text-accent text-2xl">-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Invitados Principales:</span>
                  <span id="main-guests" class="font-bold text-text-secondary">-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Acompa√±antes:</span>
                  <span id="plus-ones" class="font-bold text-text-secondary">-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Ni√±os:</span>
                  <span id="people-children" class="font-bold text-text-secondary">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Invitations -->
        <div id="content-invitations" class="tab-content hidden">
          <div class="mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-status-info/15 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-status-info" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-text-muted">Total Enviadas</p>
                    <p id="invitations-total" class="text-2xl font-bold text-text-primary">-</p>
                  </div>
                </div>
              </div>

              <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-status-success/15 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-status-success" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-text-muted">Con Respuesta</p>
                    <p id="invitations-responded" class="text-2xl font-bold text-text-primary">-</p>
                  </div>
                </div>
              </div>

              <div class="bg-bg-panel rounded-lg p-6 shadow-sm border border-border-soft/60">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-status-warning/15 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-status-warning" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-text-muted">Pendientes</p>
                    <p id="invitations-pending" class="text-2xl font-bold text-text-primary">-</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-bg-panel rounded-lg shadow-sm border border-border-soft/60 overflow-hidden">
              <div class="px-6 py-4 border-b border-border-strong/60">
                <h3 class="font-serif text-lg text-text-secondary">Invitaciones Enviadas</h3>
              </div>
              
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-border-strong/60">
                  <thead class="bg-surface-2">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Invitado</th>
                      <th class="hidden lg:table-cell px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Mensaje</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Estado</th>
                      <th class="hidden md:table-cell px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Fecha Creaci√≥n</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="invitations-table-body" class="bg-bg-panel divide-y divide-border-strong/60">
                    <!-- Contenido din√°mico -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Guests List -->
        <div id="content-guests" class="tab-content hidden">
          <div id="full-guests-cards" class="md:hidden bg-bg-panel rounded-lg shadow-sm border border-border-soft/60 divide-y divide-border-strong/60 overflow-hidden"></div>

          <div class="hidden md:block bg-bg-panel rounded-lg shadow-sm border border-border-soft/60 overflow-hidden">
            <div class="px-6 py-4 border-b border-border-strong/60">
              <h3 class="font-serif text-lg text-text-secondary">Lista Completa de Invitados</h3>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-border-strong/60">
                <thead class="bg-surface-2">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Nombre</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Acompa√±antes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Men√∫</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Rest. Diet√©ticas</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Alergias ni√±os</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Ni√±os</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Transporte</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Notas</th>
                  </tr>
                </thead>
                <tbody id="full-guests-table-body" class="bg-bg-panel divide-y divide-border-strong/60">
                  <!-- Contenido din√°mico -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>    <!-- 
Modal para crear invitaci√≥n -->
    <div id="invitation-modal" class="hidden fixed inset-0 bg-text-secondary bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-4 md:top-10 mx-4 md:mx-auto p-4 md:p-5 border w-auto max-w-4xl shadow-lg rounded-md bg-bg-panel">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-text-primary mb-4">Crear Nueva Invitaci√≥n</h3>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 md:gap-6">
            <!-- Formulario -->
            <div>
              <form id="invitation-form" class="space-y-4">
                <div>
                  <label for="guest_name" class="block text-sm font-medium text-text-secondary mb-2">Dedicatoria del invitado</label>
                  <input type="text" id="guest_name" name="guest_name" required
                    class="w-full px-3 py-2 border border-border-strong rounded-md focus:ring-accent focus:border-accent"
                    placeholder="Ej: Querido amigo" />
                </div>
                
                <div>
                  <label for="message" class="block text-sm font-medium text-text-secondary mb-2">Mensaje Personalizado (Opcional)</label>
                  <textarea id="message" name="message" rows="4"
                    class="w-full px-3 py-2 border border-border-strong rounded-md focus:ring-accent focus:border-accent"
                    placeholder="Mensaje especial para este invitado..."></textarea>
                </div>
                
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4">
                  <button type="button" id="cancel-invitation"
                    class="px-4 py-2 bg-border-strong text-text-secondary rounded-md hover:bg-border-strong/80 transition-colors">
                    Cancelar
                  </button>
                  <button type="submit" id="create-invitation-submit"
                    class="px-4 py-2 bg-accent text-accent-contrast rounded-md hover:bg-accent-hover transition-colors">
                    Crear Invitaci√≥n
                  </button>
                </div>
              </form>
            </div>

            <!-- Preview -->
            <div>
              <h4 class="text-sm font-medium text-text-secondary mb-3">Vista Previa de la Invitaci√≥n</h4>
              <div class="border border-border-strong/60 rounded-lg p-4 bg-gradient-to-br from-bg-page to-bg-card min-h-[300px]">
                <div class="text-center">
                  <div class="mb-4">
                    <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center mx-auto mb-3">
                      <svg class="w-6 h-6 text-accent-contrast" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                    <h2 class="font-serif text-xl text-text-secondary mb-2">¬°Est√°s Invitado!</h2>
                    <p class="text-text-muted text-sm mb-4">Sheila & Habib</p>
                  </div>
                  
                  <div class="bg-bg-panel/50 rounded-lg p-4 mb-4">
                    <p class="text-text-secondary mb-2">
                      <span id="preview-name" class="text-accent font-medium">Dedicatoria del Invitado</span>
                    </p>
                    <div id="preview-message" class="text-text-muted text-sm italic">
                      Nos complace invitarte a celebrar nuestro d√≠a especial.
                    </div>
                  </div>
                  
                  <div class="text-xs text-text-muted">
                    <p class="mb-1">üìÖ 4 de Julio, 2026</p>
                    <p>üìç Palacio Jardines de la Dehesa ¬∑ Lucena, C√≥rdoba</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de √©xito -->
    <div id="success-modal" class="hidden fixed inset-0 bg-text-secondary bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-12 md:top-20 mx-auto p-5 border w-[calc(100%-2rem)] max-w-md shadow-lg rounded-md bg-bg-panel">
        <div class="text-center">
          <div class="w-16 h-16 bg-status-success/15 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-status-success" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-text-primary mb-2">¬°Invitaci√≥n Creada!</h3>
          <p class="text-text-muted mb-4">La invitaci√≥n se ha generado correctamente</p>
          
          <div class="bg-surface-2 rounded-lg p-4 mb-4">
            <p class="text-sm text-text-secondary mb-2">Enlace de la invitaci√≥n:</p>
            <div class="flex items-center space-x-2">
              <input id="invitation-link" type="text" readonly 
                class="flex-1 px-3 py-2 bg-bg-panel border border-border-strong rounded text-sm" value="" />
              <button id="copy-link-btn"
                class="px-3 py-2 bg-accent text-accent-contrast rounded text-sm hover:bg-accent-hover transition-colors"
                title="Copiar enlace">üìã</button>
            </div>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-3">
            <button id="view-invitation-btn"
              class="flex-1 px-4 py-2 bg-status-info text-text-inverse rounded-md hover:bg-status-info/80 transition-colors">
              Ver Invitaci√≥n
            </button>
            <button id="close-success-modal"
              class="flex-1 px-4 py-2 bg-border-strong text-text-secondary rounded-md hover:bg-border-strong/80 transition-colors">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
    <div id="delete-confirmation-modal" class="hidden fixed inset-0 bg-text-secondary bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-12 md:top-20 mx-auto p-5 border w-[calc(100%-2rem)] max-w-md shadow-lg rounded-md bg-bg-panel">
        <div class="text-center">
          <div class="w-16 h-16 bg-status-danger/15 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-status-danger" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-text-primary mb-2">Eliminar Invitaci√≥n</h3>
          <p class="text-text-muted mb-4">
            ¬øEst√°s seguro de que quieres eliminar la invitaci√≥n para 
            <span id="delete-guest-name" class="font-semibold"></span>?
          </p>
          <p class="text-sm text-text-muted mb-6">Esta acci√≥n no se puede deshacer.</p>
          
          <div class="flex flex-col-reverse sm:flex-row gap-3">
            <button id="cancel-delete"
              class="flex-1 px-4 py-2 bg-border-strong text-text-secondary rounded-md hover:bg-border-strong/80 transition-colors">
              Cancelar
            </button>
            <button id="confirm-delete"
              class="flex-1 px-4 py-2 bg-status-danger text-text-inverse rounded-md hover:bg-status-danger/80 transition-colors">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notificaci√≥n Toast -->
    <div id="toast-notification" class="hidden fixed top-4 right-4 z-50">
      <div class="bg-status-success text-text-inverse px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <span id="toast-message">Enlace copiado al portapapeles</span>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .tab-button {
    @apply border-border-strong/70 bg-bg-panel text-text-muted hover:text-text-secondary hover:bg-surface-2 transition-colors;
  }
  
  .tab-button.active {
    @apply border-accent text-accent bg-accent/10;
  }
  
  .tab-content {
    @apply block;
  }
  
  .tab-content.hidden {
    display: none;
  }

  .tabs-scroll {
    scroll-snap-type: x proximity;
    -webkit-overflow-scrolling: touch;
  }
</style><script define:vars={{ apiUrl }}>

  // Variables globales
  let currentAnalytics = null;
  let currentInvitations = null;

  // Verificar autenticaci√≥n al cargar
  document.addEventListener('DOMContentLoaded', () => {
    const authString = sessionStorage.getItem('adminAuth');
    const adminUser = sessionStorage.getItem('adminUser');
    
    if (!authString || !adminUser) {
      window.location.href = '/admin/login';
      return;
    }
    
    // Mostrar nombre del admin
    const user = JSON.parse(adminUser);
    const adminNameEl = document.getElementById('admin-name');
    if (adminNameEl) {
      adminNameEl.textContent = `Hola, ${user.name}`;
    }
    
    // Configurar navegaci√≥n por pesta√±as
    setupTabs();
    
    // Cargar datos del dashboard
    loadDashboardData();
  });

  // Configurar navegaci√≥n por pesta√±as
  function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.id.replace('tab-', '');
        
        // Actualizar botones
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        
        // Actualizar contenido
        tabContents.forEach(content => content.classList.add('hidden'));
        const targetContent = document.getElementById(`content-${tabId}`);
        if (targetContent) {
          targetContent.classList.remove('hidden');
        }
        
        // Cargar datos espec√≠ficos de la pesta√±a
        if (tabId === 'analytics') {
          loadAnalytics();
        } else if (tabId === 'invitations') {
          loadInvitations();
        } else if (tabId === 'guests') {
          loadFullGuestsList();
        }
      });
    });
  }

  // Funci√≥n para hacer peticiones autenticadas
  async function authenticatedFetch(url, options = {}) {
    const authString = sessionStorage.getItem('adminAuth');
    if (!authString) {
      throw new Error('No authenticated');
    }
    
    // Asegurar que la URL use el puerto correcto del API
    const fullApiUrl = url.startsWith('/api/') ? `${apiUrl}${url}` : url;
    
    return fetch(fullApiUrl, {
      ...options,
      headers: {
        ...options.headers,
        'Authorization': `Basic ${authString}`,
        'Content-Type': 'application/json'
      }
    });
  }

  // Cargar datos del dashboard
  async function loadDashboardData() {
    try {
      const response = await authenticatedFetch('/api/admin/summary');
      const data = await response.json();
      
      if (data.success) {
        updateStatistics(data.summary.statistics);
        updateGuestsTable(data.summary.recent_responses);
        
        // Mostrar contenido
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('dashboard-content')?.classList.remove('hidden');
      } else {
        throw new Error(data.message);
      }
    } catch (error) {
      console.error('Error loading dashboard:', error);
      alert('Error al cargar los datos. Verifica tu conexi√≥n.');
    }
  }

  // Cargar estad√≠sticas avanzadas
  async function loadAnalytics() {
    if (currentAnalytics) {
      updateAnalyticsDisplay(currentAnalytics);
      return;
    }

    try {
      const response = await authenticatedFetch('/api/admin/analytics');
      const data = await response.json();
      
      if (data.success) {
        currentAnalytics = data.analytics.guests; // Extract the guests data
        updateAnalyticsDisplay(currentAnalytics);
      }
    } catch (error) {
      console.error('Error loading analytics:', error);
    }
  }

  // Cargar invitaciones
  async function loadInvitations() {
    try {
      const response = await authenticatedFetch('/api/admin/invitations');
      const data = await response.json();
      
      if (data.success) {
        currentInvitations = data;
        updateInvitationsDisplay(data);
      }
    } catch (error) {
      console.error('Error loading invitations:', error);
    }
  }

  // Cargar lista completa de invitados
  async function loadFullGuestsList() {
    try {
      const response = await authenticatedFetch('/api/admin/export?format=json');
      const data = await response.json();
      
      if (data.success) {
        updateFullGuestsTable(data.guests);
      }
    } catch (error) {
      console.error('Error loading full guests list:', error);
    }
  } 
 // Actualizar estad√≠sticas b√°sicas
  function updateStatistics(stats) {
    // Use the new nested structure
    const basic = stats.basic || {};
    const composition = stats.composition || {};
    const logistics = stats.logistics || {};
    
    document.getElementById('confirmed-count').textContent = basic.attending || '0';
    document.getElementById('declined-count').textContent = basic.notAttending || '0';
    document.getElementById('pending-count').textContent = basic.pending || '0';
    document.getElementById('total-people-overview').textContent = basic.totalPeople || '0';
    
    // Update additional stats if elements exist
    const plusOneElement = document.getElementById('plus-one-count');
    if (plusOneElement) {
      plusOneElement.textContent = composition.withCompanions || '0';
    }
    
    const childrenElement = document.getElementById('children-count');
    if (childrenElement) {
      childrenElement.textContent = composition.totalChildren || '0';
    }
    
    const transportElement = document.getElementById('transport-count');
    if (transportElement) {
      transportElement.textContent = logistics.transportCount || '0';
    }
  }

  function formatGenderLabel(gender) {
    const labels = {
      masculino: 'Masculino',
      femenino: 'Femenino',
      otro: 'Otro'
    };
    if (!gender) return 'No especificado';
    return labels[gender] || gender;
  }

  function formatMenuLabel(menuChoice) {
    const labels = {
      carne: 'Men√∫ con carne',
      pescado: 'Men√∫ con pescado',
      vegetariano: 'Men√∫ vegetariano',
      vegano: 'Men√∫ vegano'
    };
    if (!menuChoice) return 'No especificado';
    return labels[menuChoice] || menuChoice;
  }

  function formatCompanionEntry(companion) {
    const name = companion?.name || 'Sin nombre';
    const gender = formatGenderLabel(companion?.gender);
    const menu = formatMenuLabel(companion?.menu_choice);
    return `${name} ¬∑ ${gender} ¬∑ ${menu}`;
  }

  function formatTransportRole(role) {
    const roleLabels = {
      host: 'Host',
      companion: 'Acompa√±ante',
      child: 'Ni√±o'
    };
    return roleLabels[role] || 'Persona';
  }

  // Actualizar tabla de invitados recientes
  function updateGuestsTable(guests) {
    const tbody = document.getElementById('guests-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = guests.map(guest => {
      const status = guest.attending === 1 ? 'Confirmado' : guest.attending === 0 ? 'No asiste' : 'Pendiente';
      const statusClass = guest.attending === 1 ? 'text-status-success' : guest.attending === 0 ? 'text-status-danger' : 'text-status-warning';
      const plusOne = (guest.companions || []).length > 0
        ? guest.companions.map(formatCompanionEntry).join('<br>')
        : 'No';
      const date = new Date(guest.created_at).toLocaleDateString('es-ES');
      
      return `
        <tr>
          <td class="px-6 py-4 text-sm font-medium text-text-primary">
            <p class="whitespace-nowrap">${guest.name}</p>
            <p class="mt-1 text-xs text-text-muted md:hidden">Acompa√±antes: ${plusOne.replace(/<br>/g, ', ')}</p>
          </td>
          <td class="hidden lg:table-cell px-6 py-4 whitespace-nowrap text-sm">${guest.email || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${status}</td>
          <td class="hidden md:table-cell px-6 py-4 text-sm text-text-muted">${plusOne}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted">${date}</td>
        </tr>
      `;
    }).join('');
  }

  // Actualizar display de estad√≠sticas avanzadas
  function updateAnalyticsDisplay(analytics) {
    // Use the new structure directly (analytics is the stats object)
    const basic = analytics.basic || {};
    const composition = analytics.composition || {};
    const demographics = analytics.demographics || {};
    const catering = analytics.catering || {};
    const logistics = analytics.logistics || {};
    
    // Actualizar contadores principales
    document.getElementById('total-people').textContent = basic.totalPeople || '0';
    document.getElementById('main-guests').textContent = basic.attending || '0';
    document.getElementById('plus-ones').textContent = composition.totalCompanions || '0';
    document.getElementById('demographics-children').textContent = composition.totalChildren || '0';
    document.getElementById('people-children').textContent = composition.totalChildren || '0';
    
    // Estad√≠sticas de transporte
    const transportTotal = logistics.transportPeopleTotal ?? logistics.transportCount ?? 0;
    document.getElementById('transport-needed').textContent = String(transportTotal);

    const transportPeopleEl = document.getElementById('transport-people-list');
    if (transportPeopleEl) {
      const people = logistics.transportPeople || [];
      if (people.length === 0) {
        transportPeopleEl.innerHTML = '<p class="text-text-muted text-sm">Sin personas registradas</p>';
      } else {
        transportPeopleEl.innerHTML = people.map(person => `
          <div class="py-1 border-b border-border-strong/30 last:border-b-0">
            <p class="text-sm text-text-secondary font-medium">${person.name}</p>
            <p class="text-xs text-text-muted">${formatTransportRole(person.role)} ¬∑ Grupo: ${person.host}</p>
          </div>
        `).join('');
      }
    }
    
    // Estad√≠sticas de g√©nero (invitados principales)
    updateStatsSection('gender-stats', demographics.mainGuests || []);
    
    // Estad√≠sticas de men√∫ consolidadas
    updateStatsSection('menu-stats', catering.menuChoices || []);
    
    // Restricciones diet√©ticas con nombres de personas
    const dietaryEl = document.getElementById('dietary-stats');
    if (dietaryEl) {
      const items = catering.dietaryRestrictions || [];
      if (items.length === 0) {
        dietaryEl.innerHTML = '<p class="text-text-muted text-sm">Sin restricciones registradas</p>';
      } else {
        dietaryEl.innerHTML = items.map(item =>
          `<div class="py-1">
            <span class="text-text-secondary font-medium">${item.restriction}:</span>
            <span class="text-text-muted text-xs ml-1">${item.people}</span>
          </div>`
        ).join('');
      }
    }
    
    // Estad√≠sticas de ni√±os
    const childrenElement = document.getElementById('children-stats');
    if (childrenElement) {
      const childrenBreakdown = composition.childrenBreakdown || [];
      if (childrenBreakdown.length === 0) {
        childrenElement.innerHTML = '<p class="text-text-muted text-sm">Sin ni√±os registrados</p>';
      } else {
        childrenElement.innerHTML = childrenBreakdown.map(item => 
          `<div class="flex justify-between py-1">
            <span>${item.count} ni√±o${item.count > 1 ? 's' : ''}</span>
            <span class="font-medium">${item.families} familia${item.families > 1 ? 's' : ''}</span>
          </div>`
        ).join('');
      }
    }
    
    // Informaci√≥n de contacto
    const contactElement = document.getElementById('contact-stats');
    if (contactElement && logistics.phoneNumbers) {
      contactElement.innerHTML = logistics.phoneNumbers.map(contact => 
        `<div class="flex justify-between py-1">
          <span>${contact.name}</span>
          <span class="font-medium">${contact.phone}</span>
        </div>`
      ).join('') || '<p class="text-text-muted text-sm">Sin tel√©fonos disponibles</p>';
    }
  }

  // Funci√≥n auxiliar para actualizar secciones de estad√≠sticas
  function updateStatsSection(elementId, data) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    if (data.length === 0) {
      element.innerHTML = '<p class="text-text-muted text-sm">Sin datos disponibles</p>';
      return;
    }
    
    element.innerHTML = data.map(item => {
      // Handle different data structures
      const label = item.gender || item.menu_choice || item.restriction || item.menu_type || 'Sin especificar';
      const count = item.count || 0;
      
      return `
        <div class="flex justify-between items-center">
          <span class="text-text-secondary">${label}:</span>
          <span class="font-medium text-text-primary">${count}</span>
        </div>
      `;
    }).join('');
  }

  // Actualizar display de invitaciones
  function updateInvitationsDisplay(data) {
    // Actualizar estad√≠sticas de invitaciones
    document.getElementById('invitations-total').textContent = data.statistics.total || '0';
    document.getElementById('invitations-responded').textContent = data.statistics.responded || '0';
    document.getElementById('invitations-pending').textContent = data.statistics.pending || '0';
    
    // Actualizar tabla de invitaciones
    const tbody = document.getElementById('invitations-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = data.invitations.map((invitation) => {
      const date = new Date(invitation.created_at).toLocaleDateString('es-ES');
      const message = invitation.message ? invitation.message.substring(0, 50) + '...' : 'Sin mensaje';
      const status = 'Enviada'; // Por ahora, todas est√°n enviadas
      
      return `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">${invitation.guest_name}</td>
          <td class="hidden lg:table-cell px-6 py-4 whitespace-nowrap text-sm text-text-muted">${message}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-status-info">${status}</td>
          <td class="hidden md:table-cell px-6 py-4 whitespace-nowrap text-sm text-text-muted">${date}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted">
            <button onclick="viewInvitation('${invitation.token}')" class="text-status-info hover:text-status-info/80 mr-2 inline-block mb-1 md:mb-0" title="Ver invitaci√≥n">Ver</button>
            <button onclick="copyInvitationLink('${invitation.token}')" class="text-status-success hover:text-status-success/80 mr-2 inline-block mb-1 md:mb-0" title="Copiar enlace">Copiar</button>
            <button onclick="deleteInvitation('${invitation.id}', '${invitation.guest_name}')" class="text-status-danger hover:text-status-danger/80" title="Eliminar invitaci√≥n">Eliminar</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // Actualizar tabla completa de invitados
  function updateFullGuestsTable(guests) {
    const tbody = document.getElementById('full-guests-table-body');
    const cardsContainer = document.getElementById('full-guests-cards');
    if (!tbody) return;

    tbody.innerHTML = guests.map(guest => {
      const status = guest.attending === 1 ? 'Confirmado' : guest.attending === 0 ? 'No asiste' : 'Pendiente';
      const statusClass = guest.attending === 1 ? 'text-status-success' : guest.attending === 0 ? 'text-status-danger' : 'text-status-warning';
      const genderLabel = guest.gender ? `<span class="text-xs text-text-muted">${formatGenderLabel(guest.gender)}</span>` : '';
      const phoneLabel = guest.phone ? `<span class="text-xs text-text-muted">${guest.phone}</span>` : '';
      const companions = (guest.companions || []).length > 0
        ? guest.companions.map(c => formatCompanionEntry(c)).join('<br>')
        : '<span class="text-text-muted">Ninguno</span>';
      const menu = guest.menu_choice || '-';
      const dietary = guest.dietary_restrictions || '-';
      const childrenDietary = guest.children_dietary_restrictions || '-';
      const children = guest.children ? `${guest.children_count} (${guest.children_names || 'sin nombres'})` : 'No';
      const transport = guest.needs_transport ? 'S√≠' : 'No';
      const notes = guest.notes || '-';

      return `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-text-primary">${guest.name}</div>
            <div class="flex gap-2 mt-0.5">${genderLabel}${genderLabel && phoneLabel ? '<span class="text-text-muted">¬∑</span>' : ''}${phoneLabel}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${guest.email || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${status}</td>
          <td class="px-6 py-4 text-sm text-text-muted">${companions}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted">${menu}</td>
          <td class="px-6 py-4 text-sm text-text-muted">${dietary}</td>
          <td class="px-6 py-4 text-sm text-text-muted">${childrenDietary}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted">${children}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted">${transport}</td>
          <td class="px-6 py-4 text-sm text-text-muted">${notes}</td>
        </tr>
      `;
    }).join('');

    if (cardsContainer) {
      cardsContainer.innerHTML = guests.map(guest => {
        const status = guest.attending === 1 ? 'Confirmado' : guest.attending === 0 ? 'No asiste' : 'Pendiente';
        const statusClass = guest.attending === 1 ? 'text-status-success' : guest.attending === 0 ? 'text-status-danger' : 'text-status-warning';
        const companions = (guest.companions || []).length > 0
          ? guest.companions.map(c => formatCompanionEntry(c)).join(' ¬∑ ')
          : 'Ninguno';
        const menu = formatMenuLabel(guest.menu_choice);
        const children = guest.children ? `${guest.children_count} (${guest.children_names || 'sin nombres'})` : 'No';
        const transport = guest.needs_transport ? 'S√≠' : 'No';

        return `
          <article class="p-4 space-y-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h4 class="text-sm font-medium text-text-primary">${guest.name}</h4>
                <p class="text-xs text-text-muted">${guest.email || '-'}</p>
              </div>
              <span class="text-xs font-medium ${statusClass}">${status}</span>
            </div>
            <div class="grid grid-cols-2 gap-x-3 gap-y-2 text-xs">
              <p class="text-text-muted">Men√∫: <span class="text-text-secondary">${menu}</span></p>
              <p class="text-text-muted">Ni√±os: <span class="text-text-secondary">${children}</span></p>
              <p class="text-text-muted">Transporte: <span class="text-text-secondary">${transport}</span></p>
              <p class="text-text-muted">Sexo: <span class="text-text-secondary">${formatGenderLabel(guest.gender)}</span></p>
            </div>
            <p class="text-xs text-text-muted"><span class="text-text-secondary">Acompa√±antes:</span> ${companions}</p>
            ${guest.dietary_restrictions ? `<p class="text-xs text-text-muted"><span class="text-text-secondary">Restricciones:</span> ${guest.dietary_restrictions}</p>` : ''}
            ${guest.notes ? `<p class="text-xs text-text-muted"><span class="text-text-secondary">Notas:</span> ${guest.notes}</p>` : ''}
          </article>
        `;
      }).join('');
    }
  }
  
  // Variables para el modal de eliminaci√≥n
  let invitationToDelete = null;

  // Funciones globales para gesti√≥n de invitaciones
  window.viewInvitation = function(token) {
    window.open(`/invitacion/${token}`, '_blank');
  };

  window.copyInvitationLink = function(token) {
    const link = `${window.location.origin}/invitacion/${token}`;
    navigator.clipboard.writeText(link).then(() => {
      showToast('Enlace copiado al portapapeles');
    });
  };

  // Funci√≥n para mostrar modal de confirmaci√≥n de eliminaci√≥n
  window.deleteInvitation = function(invitationId, guestName) {
    invitationToDelete = invitationId;
    document.getElementById('delete-guest-name').textContent = guestName;
    document.getElementById('delete-confirmation-modal').classList.remove('hidden');
  };

  // Funci√≥n para confirmar eliminaci√≥n
  async function confirmDeleteInvitation() {
    if (!invitationToDelete) return;

    try {
      const response = await authenticatedFetch(`/api/admin/invitations/${invitationToDelete}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        showToast('Invitaci√≥n eliminada correctamente');
        // Recargar la lista de invitaciones
        loadInvitations();
      } else {
        showToast(data.message || 'Error al eliminar la invitaci√≥n', 'error');
      }
    } catch (error) {
      console.error('Error deleting invitation:', error);
      showToast('Error al eliminar la invitaci√≥n', 'error');
    } finally {
      // Cerrar modal y limpiar variable
      document.getElementById('delete-confirmation-modal').classList.add('hidden');
      invitationToDelete = null;
    }
  }

  // Funci√≥n para cancelar eliminaci√≥n
  function cancelDeleteInvitation() {
    document.getElementById('delete-confirmation-modal').classList.add('hidden');
    invitationToDelete = null;
  }

  // Funci√≥n para mostrar toast notification
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');
    
    if (toast && toastMessage) {
      toastMessage.textContent = message;
      
      // Cambiar color seg√∫n el tipo
      const toastDiv = toast.querySelector('div');
      if (toastDiv) {
        toastDiv.className = type === 'success' 
          ? 'bg-status-success text-text-inverse px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3'
          : 'bg-status-danger text-text-inverse px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3';
      }
      
      toast.classList.remove('hidden');
      
      // Auto-hide despu√©s de 3 segundos
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
  }

  // Funci√≥n para actualizar preview en tiempo real
  function updatePreview() {
    const nameInput = document.getElementById('guest_name');
    const messageInput = document.getElementById('message');
    const previewName = document.getElementById('preview-name');
    const previewMessage = document.getElementById('preview-message');
    
    if (previewName && nameInput) {
      previewName.textContent = nameInput.value || 'Dedicatoria del Invitado (Ej: Querido amigo)';
    }
    
    if (previewMessage && messageInput) {
      previewMessage.textContent = messageInput.value || 'Nos complace invitarte a celebrar nuestro d√≠a especial.';
    }
  }

  // Event listeners
  document.getElementById('logout-btn')?.addEventListener('click', () => {
    sessionStorage.removeItem('adminAuth');
    sessionStorage.removeItem('adminUser');
    window.location.href = '/admin/login';
  });

  document.getElementById('refresh-btn')?.addEventListener('click', () => {
    document.getElementById('loading-state')?.classList.remove('hidden');
    document.getElementById('dashboard-content')?.classList.add('hidden');
    currentAnalytics = null;
    currentInvitations = null;
    loadDashboardData();
  });

  document.getElementById('export-json-btn')?.addEventListener('click', async () => {
    try {
      const response = await authenticatedFetch('/api/admin/export?format=json');
      const data = await response.json();
      
      if (data.success) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invitados_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }
    } catch (error) {
      alert('Error al exportar datos');
    }
  });

  document.getElementById('export-csv-btn')?.addEventListener('click', async () => {
    try {
      const response = await authenticatedFetch('/api/admin/export?format=csv');
      const csvData = await response.text();
      
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `invitados_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      alert('Error al exportar CSV');
    }
  });

  // Modal de invitaci√≥n
  document.getElementById('create-invitation-btn')?.addEventListener('click', () => {
    document.getElementById('invitation-modal')?.classList.remove('hidden');
    updatePreview(); // Actualizar preview inicial
  });

  document.getElementById('cancel-invitation')?.addEventListener('click', () => {
    document.getElementById('invitation-modal')?.classList.add('hidden');
    document.getElementById('invitation-form')?.reset();
    updatePreview(); // Reset preview
  });

  // Event listeners para actualizar preview en tiempo real
  document.getElementById('guest_name')?.addEventListener('input', updatePreview);
  document.getElementById('message')?.addEventListener('input', updatePreview);

  // Modal de √©xito - Event listeners
  document.getElementById('close-success-modal')?.addEventListener('click', () => {
    document.getElementById('success-modal')?.classList.add('hidden');
  });

  document.getElementById('copy-link-btn')?.addEventListener('click', async () => {
    const linkInput = document.getElementById('invitation-link');
    
    try {
      await navigator.clipboard.writeText(linkInput.value);
      showToast('Enlace copiado al portapapeles');
    } catch (error) {
      // Fallback para navegadores que no soportan clipboard API
      linkInput.select();
      document.execCommand('copy');
      showToast('Enlace copiado al portapapeles');
    }
  });

  document.getElementById('view-invitation-btn')?.addEventListener('click', () => {
    const linkInput = document.getElementById('invitation-link');
    window.open(linkInput.value, '_blank');
  });

  // Formulario de invitaci√≥n
  document.getElementById('invitation-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('create-invitation-submit');
    const originalText = submitBtn.textContent;
    
    try {
      // Deshabilitar bot√≥n y mostrar loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creando...';
      
      const formData = new FormData(e.target);
      const invitationData = {
        guest_name: formData.get('guest_name'),
        message: formData.get('message')
      };
      
      const response = await authenticatedFetch('/api/admin/invitations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(invitationData)
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Cerrar modal de creaci√≥n
        document.getElementById('invitation-modal')?.classList.add('hidden');
        document.getElementById('invitation-form')?.reset();
        
        // Configurar y mostrar modal de √©xito
        const invitationLink = `${window.location.origin}/invitacion/${data.invitation.token}`;
        const linkInput = document.getElementById('invitation-link');
        linkInput.value = invitationLink;
        
        document.getElementById('success-modal')?.classList.remove('hidden');
        
        // Mostrar toast de √©xito
        showToast('¬°Invitaci√≥n creada exitosamente!');
        
        // Recargar datos del dashboard
        loadDashboardData();
        
        // Limpiar cache de invitaciones para recargar
        currentInvitations = null;
        
        // Reset preview
        updatePreview();
      } else {
        throw new Error(data.message);
      }
    } catch (error) {
      console.error('Error creating invitation:', error);
      showToast('Error al crear la invitaci√≥n: ' + error.message, 'error');
    } finally {
      // Restaurar bot√≥n
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  // Event listeners para modal de eliminaci√≥n
  document.getElementById('confirm-delete')?.addEventListener('click', confirmDeleteInvitation);
  document.getElementById('cancel-delete')?.addEventListener('click', cancelDeleteInvitation);

  // Cerrar modal al hacer clic fuera de √©l
  document.getElementById('delete-confirmation-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'delete-confirmation-modal') {
      cancelDeleteInvitation();
    }
  });
</script>
</BaseLayout>
