---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import olivoBottomLeft from '../../assets/olive/olivo-bottom-left.png';


const { token } = Astro.params;
const apiUrl = import.meta.env.API_URL || 'http://localhost:3001';
---

<BaseLayout title="Invitación - Sheila & Habib">
  <main class="min-h-screen bg-bg-page py-12">
    <div class="container mx-auto px-4 flex justify-center">
      <!-- Loading State -->
      <div id="loading-state" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
        <p class="text-text-muted">Cargando invitación...</p>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden w-full max-w-[680px]">
        <div class="bg-bg-panel rounded-lg shadow-sm border border-border-soft/60 p-8 max-w-md mx-auto text-center">
          <h1 class="text-2xl font-bold text-text-secondary mb-2">Invitación no encontrada</h1>
          <p id="error-message" class="text-text-muted mb-4">No pudimos cargar esta invitación</p>
          <a
            href="/"
            class="inline-block bg-accent text-accent-contrast px-6 py-2 rounded-lg hover:bg-accent-hover transition-colors"
          >
            Ir a la página principal
          </a>
        </div>
      </div>

      <!-- Invitation Content -->
      <div id="invitation-content" class="hidden w-full max-w-[680px]">
        <!-- Hoja de invitación tipo papel (estilo Lovable) -->
        <section
          class="relative w-full mx-auto bg-bg-card shadow-card rounded-sm overflow-hidden border border-border-soft"
        >
          {/* Ramas de olivo SUPERIOR (Derecha) */}
          <div class="absolute -top-10 -right-10 w-32 h-32 md:w-64 md:h-64 md:-top-24 md:-right-24 pointer-events-none z-0 transform-gpu">
            <img
              src={olivoBottomLeft.src}
              alt=""
              aria-hidden="true"
              class="w-full h-full object-contain mix-blend-multiply rotate-180 filter grayscale opacity-70"
            />
          </div>

          {/* Ramas de olivo INFERIOR (Izquierda) */}
          <div class="absolute -bottom-10 -left-10 w-32 h-32 md:w-64 md:h-64 md:-bottom-24 md:-left-32 pointer-events-none z-0 transform-gpu">
            <img
              src={olivoBottomLeft.src}
              alt=""
              aria-hidden="true"
              class="w-full h-full object-contain mix-blend-multiply filter grayscale opacity-70"
            />
          </div>

          {/* Contenido de la invitación */}
          <div class="relative z-10 px-8 py-20 md:px-16 md:py-20 text-center space-y-10">
            {/* Cabecera: nombres y tagline */}
            <header class="space-y-5">
              <p class="text-[11px] tracking-[0.4em] uppercase text-text-muted/70">
                ¡Nos casamos!
              </p>

              <div class="space-y-3 text-text-primary">
                <h1 class="font-display text-[clamp(31px,9.5vw,50px)] sm:text-5xl md:text-6xl leading-[0.95] tracking-[0.01em] font-medium whitespace-nowrap">
                  Sheila <span class="text-[0.6em] sm:text-3xl md:text-4xl align-middle opacity-80">&amp;</span> Habib
                </h1>
              </div>
            </header>

            {/* Texto principal de invitación */}
            <section class="space-y-4 max-w-xl mx-auto text-left text-[15px] leading-relaxed text-text-secondary">
              <p id="guest-name" class="font-semibold">
                Querido/a Invitado/a,
              </p>

              <p id="personal-message">
                Nos encantaría que nos acompañaras en un día tan especial para nosotros. Tu presencia
                hará que nuestra boda sea aún más inolvidable.
              </p>

              <p>
                Tenemos el gusto de invitarte a la ceremonia civil que se celebrará el
                <span class="font-semibold">
                  {' '}sábado, 4 de julio de 2026, a las 20:15h,
                </span>en
                <span class="font-semibold">Los Jardines Palacio de La Dehesa,</span> en Lucena
                (Córdoba).
              </p>
              <p class="pt-3 text-right">
                Con cariño,<br />
                <span class="font-display text-[16px] md:text-[17px] opacity-90">Sheila &amp; Habib</span>
              </p>
            </section>
          </div>
        </section>

        {/* Detalles y acciones fuera de la tarjeta principal */}
        <section class="mt-10 md:mt-12 max-w-[780px] mx-auto bg-bg-panel/80 border border-border-soft rounded-lg shadow-sm backdrop-blur px-6 py-8 md:px-10 space-y-8">
          <div class="space-y-4">
            <h2 class="font-display text-2xl text-center text-text-primary">
              Detalles del evento
            </h2>

            <ol class="space-y-6 text-sm text-left text-text-secondary">
              <li class="flex gap-4">
                <div class="mt-1 h-3 w-3 rounded-full bg-accent flex-shrink-0"></div>
                <div class="space-y-1">
                  <h3 class="font-medium text-text-primary">Ceremonia civil</h3>
                  <p>
                    <span class="font-medium">Sábado, 4 de julio de 2026 · 20:15h</span>
                  </p>
                  <p>
                    <a
                      href="https://maps.app.goo.gl/TQENkxEA9Pz8y9Ze6"
                      target="_blank"
                      rel="noreferrer"
                      class="inline-flex flex-wrap items-center gap-2 text-accent underline decoration-accent/60 underline-offset-4 hover:text-accent-hover hover:decoration-accent"
                    >
                      <span class="text-text-secondary">
                        Los Jardines Palacio de La Dehesa · Lucena, Córdoba
                      </span>
                      <span class="text-xs uppercase tracking-[0.18em] font-semibold text-accent">
                        Ver mapa
                      </span>
                    </a>
                  </p>
                </div>
              </li>

              <li class="flex gap-4">
                <div class="mt-1 h-3 w-3 rounded-full bg-accent flex-shrink-0"></div>
                <div class="space-y-1">
                  <h3 class="font-medium text-text-primary">Cóctel, cena y fiesta</h3>
                  <p>
                    A partir de las <span class="font-medium">21:15h</span> · Mismo lugar
                  </p>
                  <p>
                    Código de vestimenta:
                    <span class="font-medium">Boho sencillo/Ibicenca</span>
                    <a 
                    href="/#dresscode"
                    class="text-accent underline decoration-accent/60 underline-offset-4 hover:text-accent-hover hover:decoration-accent"
                    >Saber más</a>
                  </p>
                </div>
              </li>
            </ol>
          </div>

          <div class="pt-2 border-t border-border-soft/70 space-y-4">
            <p class="text-center text-text-secondary text-sm">
              Para ayudarnos con la organización, te agradeceríamos que confirmaras tu asistencia en el botón de aquí abajo.
            </p>
            <p class="text-center text-text-secondary text-xs">
              ¡No te sientas solo, trae a alguien especial contigo si lo deseas!
            </p>

            <div class="flex flex-col gap-4 text-center">
              <a
                href="/rsvp/login"
                class="cta-bounce block w-full bg-accent text-text-inverse py-3 px-6 rounded-lg text-center font-medium border border-white/20 shadow-[0_12px_30px_rgba(0,0,0,0.18)] transition-all duration-300 hover:brightness-95 hover:shadow-[0_16px_38px_rgba(0,0,0,0.22)] hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-0"
              >
                Confirmar mi asistencia
              </a>

              <p class="text-center text-text-secondary text-sm">
                Si quieres saber información detallada del evento aquí abajo tienes todo lo que necesitas saber (Alojamiento, ubicación, transporte...).
              </p>
              <a
                href="/"
                class="block w-full bg-accent text-accent-contrast py-3 px-6 rounded-lg text-center font-medium transition-all duration-300 hover:brightness-95 hover:shadow-card hover:-translate-y-0.5"
              >
                Más información del evento
              </a>

              <button
                id="download-summary"
                class="w-full bg-text-primary text-text-inverse py-3 px-6 rounded-lg font-medium hover:bg-text-primary/90 transition-colors"
              >
                Descargar resumen
              </button>
            </div>
          </div>
        </section>

        <!-- Token info -->
        <div class="mt-4 text-center">
          <p class="text-xs text-text-muted">
            Invitación personalizada · <span id="token-display"></span>
          </p>
        </div>
      </div>
    </div>
  </main>

  <script define:vars={{ token, apiUrl }}>
    async function loadInvitation() {
      try {
        const response = await fetch(`${apiUrl}/api/invitacion/${token}`);

        if (response.ok) {
          const data = await response.json();

          if (data.success) {
            document.getElementById('guest-name').textContent = data.invitation.guest_name;
            document.getElementById('personal-message').textContent =
              data.invitation.message ||
              'Nos encantaría que nos acompañaras en un día tan especial para nosotros. Tu presencia hará que nuestra boda sea aún más inolvidable.';
            document.getElementById('token-display').textContent =
              token.slice(0, 8) + '...';

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('invitation-content').classList.remove('hidden');
          } else {
            throw new Error(data.message || 'Invitación no encontrada');
          }
        } else {
          throw new Error('Invitación no encontrada');
        }
      } catch (error) {
        console.error('Error loading invitation:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
      }
    }

    function downloadSummary() {
      const link = document.createElement('a');
      link.href = '/images/summary/resumenBodaSheilaYHabib.png';
      link.download = 'resumenBodaSheilaYHabib.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadInvitation();
      document
        .getElementById('download-summary')
        ?.addEventListener('click', downloadSummary);
    });
  </script>

  <style>
    .cta-bounce {
      animation: cta-bounce 2.6s ease-in-out infinite;
      will-change: transform;
    }

    @keyframes cta-bounce {
      0%,
      100% {
        transform: translateY(0);
      }
      12% {
        transform: translateY(-6px);
      }
      24% {
        transform: translateY(0);
      }
      36% {
        transform: translateY(-3px);
      }
      48% {
        transform: translateY(0);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .cta-bounce {
        animation: none;
      }
    }
  </style>
</BaseLayout>
