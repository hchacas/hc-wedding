---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';

const { token } = Astro.params;
---

<BaseLayout title="Invitación - Sheila & Habib">
  <main class="min-h-screen bg-warm-beige py-12">
    <div class="container mx-auto px-4 max-w-4xl">
      <!-- Loading State -->
      <div id="loading-state" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gold mx-auto mb-4"></div>
        <p class="text-gray-600">Cargando invitación...</p>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center">
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 max-w-md mx-auto">
          <h1 class="text-2xl font-bold text-gray-800 mb-2">Invitación no encontrada</h1>
          <p id="error-message" class="text-gray-600 mb-4">No pudimos cargar esta invitación</p>
          <a href="/" class="inline-block bg-gold text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
            Ir a la página principal
          </a>
        </div>
      </div>

      <!-- Invitation Content -->
      <div id="invitation-content" class="hidden">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 mb-8 text-center">
          <h1 class="font-serif text-4xl text-gray-800 mb-4">
            Querido/a <span id="guest-name" class="text-gold">Invitado</span>
          </h1>
          <div class="w-16 h-0.5 bg-gold mx-auto mb-4"></div>
          <p class="text-gray-600 text-lg">
            Sheila & Habib
          </p>
        </div>

        <!-- Mensaje personalizado -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 mb-8">
          <p id="personal-message" class="text-lg text-gray-700 leading-relaxed text-center mb-6">
            Nos complace invitarte a celebrar nuestro día especial.
          </p>
          
          <div class="bg-warm-beige rounded-lg p-6 border-l-4 border-gold">
            <p class="text-gray-700 italic text-center">
              "Queremos que seas parte de este momento único en nuestras vidas. 
              Tu presencia haría nuestro día aún más especial."
            </p>
            <p class="text-right text-gold font-medium mt-4">- Sheila & Habib</p>
          </div>
        </div>

        <!-- Detalles del evento -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 mb-8">
          <h2 class="font-serif text-2xl text-gray-800 mb-6 text-center">Detalles del Evento</h2>
          
          <div class="grid md:grid-cols-2 gap-8">
            <div class="border-l-4 border-gold pl-6">
              <h3 class="font-medium text-gray-800 mb-2">Ceremonia Civil</h3>
              <p class="text-gray-600 mb-1">Viernes, 4 de Julio 2026</p>
              <p class="text-gray-600 mb-1">19:00h</p>
              <p class="text-gray-600">Los Jardines Palacio de La Dehesa</p>
            </div>
            
            <div class="border-l-4 border-gold pl-6">
              <h3 class="font-medium text-gray-800 mb-2">Cóctel, Cena y Fiesta</h3>
              <p class="text-gray-600 mb-1">20:30h - Mismo lugar</p>
              <p class="text-gray-600 mb-1">Lucena, Córdoba</p>
              <p class="text-gray-600">Código de vestimenta: Elegante</p>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8">
          <div class="grid md:grid-cols-2 gap-4">
            <a href="/rsvp/login" class="block w-full bg-gold text-white py-3 px-6 rounded-lg text-center font-medium hover:bg-yellow-600 transition-colors">
              Confirmar mi Asistencia
            </a>
            
            <button id="download-summary" class="w-full bg-gray-800 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors">
              Descargar Resumen
            </button>
          </div>
          
          <div class="mt-4">
            <a href="/" class="block w-full bg-warm-beige text-gray-800 py-3 px-6 rounded-lg text-center font-medium hover:bg-gray-100 transition-colors">
              Ver más información del evento
            </a>
          </div>
        </div>

        <!-- Token info -->
        <div class="mt-8 text-center">
          <p class="text-xs text-gray-400">
            Invitación personalizada • <span id="token-display"></span>
          </p>
        </div>
      </div>
    </div>
  </main>

  <script define:vars={{ token }}>
    // Cargar datos de la invitación dinámicamente
    async function loadInvitation() {
      try {
        const response = await fetch(`http://localhost:3001/api/invitacion/${token}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success) {
            // Actualizar contenido
            document.getElementById('guest-name').textContent = data.invitation.guest_name;
            document.getElementById('personal-message').textContent = data.invitation.message || 'Nos complace invitarte a celebrar nuestro día especial.';
            document.getElementById('token-display').textContent = token.slice(0, 8) + '...';
            
            // Mostrar invitación
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('invitation-content').classList.remove('hidden');
          } else {
            throw new Error(data.message || 'Invitación no encontrada');
          }
        } else {
          throw new Error('Invitación no encontrada');
        }
      } catch (error) {
        console.error('Error loading invitation:', error);
        
        // Mostrar error
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
      }
    }

    // Función para descargar el resumen del evento
    function downloadSummary() {
      const link = document.createElement('a');
      link.href = '/images/summary/resumenBodaSheilaYHabib.png';
      link.download = 'resumenBodaSheilaYHabib.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadInvitation();
      
      // Botón de descarga del resumen
      document.getElementById('download-summary')?.addEventListener('click', downloadSummary);
    });
  </script>
</BaseLayout>